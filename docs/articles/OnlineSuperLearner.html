<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to the Online SuperLearner • OnlineSuperLearner</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">OnlineSuperLearner</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/OnlineSuperLearner.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Introduction to the Online SuperLearner</h1>
                        <h4 class="author">Antoine Chambaz and Frank Blaauw</h4>
            
          </div>

    
    
<div class="contents">
<p><span style="color:red">Note: this guide is out of date and will be updated in the future.</span></p>
<p>In this guide we present a basic example of how the OnlineSuperLearner (OSL) can be used. The goal of OSL is to be able to make predictions and do inference on time series data in an (in machine learning terms) online fashion. In order to do so, it estimates a density function for each of the covariates, the treatment variables, and the outcome. After these densities are fitted, OSL can simulate interventions and determine the outcome given such an intervention. This package relies heavily on the <a href="https://github.com/osofr/condensier">condensier</a> package.</p>
<p>In this guide we will present the steps needed to perform a basic simulation. We will start by installing and configuring the package. Then we approximate our true parameter of interest given the simulation data. This approximated truth is used as ground truth for the rest of the algorithm. In the next step we estimate the densities and run an iteritative sampling method, in which we apply the same treatment as in the approximation step. If everything goes well, both parameters should be approximately the same. Note that this guide does not apply any TMLE.</p>
<section id="quick-start" class="level2"><h2>Quick start</h2>
</section><section id="install-dependencies" class="level2"><h2>Install dependencies</h2>
<p>Before anything else we need to install several dependencies. Most dependencies are used by OSL and some are used by Condense. First define the dependencies we need.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1">  <span class="ex">./inst/bash/install-package-dependencies.sh</span></a></code></pre></div>
<p>After installing the packages we then need to load them. We will use the local version from source for the OSL package.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">  <span class="kw">set.seed</span>(<span class="dv">12345</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  expit =<span class="st"> </span>plogis</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  logit =<span class="st"> </span>qlogis</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  packages &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">'condensier'</span>, <span class="st">'OnlineSuperLearner'</span>, packages)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6"></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  <span class="cf">if</span> (<span class="st">"package:OnlineSuperLearner"</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">search</span>()) { <span class="kw">detach</span>(<span class="st">"package:OnlineSuperLearner"</span>, <span class="dt">unload=</span><span class="ot">TRUE</span>) }</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">  <span class="cf">if</span> (<span class="st">"OnlineSuperLearner"</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">rownames</span>(<span class="kw">installed.packages</span>())) { <span class="kw">remove.packages</span>(<span class="st">"OnlineSuperLearner"</span>) }</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">  <span class="kw">install.packages</span>(<span class="st">'.'</span>, <span class="dt">repos =</span> <span class="ot">NULL</span>, <span class="dt">type=</span><span class="st">"source"</span>)</a>
<a class="sourceLine" id="cb2-10" data-line-number="10"></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">  <span class="kw">suppressWarnings</span>(</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">      <span class="kw">invisible</span>(<span class="kw">lapply</span>(packages, require, <span class="dt">character.only =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">  )</a></code></pre></div>
<p>Check if the correct functions are exported.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">  <span class="kw">getNamespaceExports</span>(<span class="st">"OnlineSuperLearner"</span>)</a></code></pre></div>
</section><section id="configuration" class="level2"><h2>Configuration</h2>
<p>The next step is to configure several parameters for the estimation procedure itself. There are several options to configure:</p>
<ul>
<li>
<code>log</code>: Whether or not we want logging of the application. Logging can be done using the R.utils verbose object, e.g.: <code>log &lt;- Arguments$getVerbose(-8, timestamp=TRUE)</code>.</li>
<li>
<code>condensier_options</code>: The options to pass to the condensier package.</li>
<li>
<code>cores</code>: The number of cores used by OSL</li>
<li>
<code>training_set_size</code>: OSL trains the estimator on a number of training examples. After that it evaluates its performance on a different (test) set.</li>
<li>
<code>max_iterations</code>: OSL will process the trainingset iteratively. That is, it won’t use all data in one go, but will use micro batches forn a <code>max_iterations</code> number of steps.</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">  <span class="co"># Set the seed</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  <span class="kw">set.seed</span>(<span class="dv">12345</span>)</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  <span class="co"># Do logging?</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">  log &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">  <span class="co"># Should condensier fit our estimators in parallel?</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">  <span class="kw">condensier_options</span>(<span class="dt">parfit=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb4-9" data-line-number="9"></a>
<a class="sourceLine" id="cb4-10" data-line-number="10">  <span class="co"># How many cores would we like to use?</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">  cores =<span class="st"> </span>parallel<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/parallel/topics/detectCores">detectCores</a></span>()</a>
<a class="sourceLine" id="cb4-12" data-line-number="12"></a>
<a class="sourceLine" id="cb4-13" data-line-number="13">  <span class="co"># Number of items we have in our testset</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14">  training_set_size &lt;-<span class="st"> </span><span class="dv">200</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"></a>
<a class="sourceLine" id="cb4-16" data-line-number="16">  <span class="co"># Number of iterations we want to use (this is for the online training part)</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17">  max_iterations =<span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"></a>
<a class="sourceLine" id="cb4-19" data-line-number="19">  <span class="co"># The calculator for estimating the risk</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20">  cv_risk_calculator &lt;-<span class="st"> </span>OnlineSuperLearner<span class="op">::</span>CrossValidationRiskCalculator<span class="op">$</span><span class="kw">new</span>()</a></code></pre></div>
<p>Now the basic configuration for the OSL is done, we can go ahead and specify which intervention we are interested in. Interventions are specified as an R list with three elements:</p>
<ul>
<li>
<code>when</code>: When should the intervention be done? (i.e., at what time <span class="math inline">\(t\)</span>)</li>
<li>
<code>what</code>: What should be the intervention we are doing? (e.g., set treatment to <span class="math inline">\(x \in \{0,1\}\)</span>)</li>
<li>
<code>variable</code>: Which variable do we consider the intervention variable? (<span class="math inline">\(A\)</span> in the TL literature)</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">  <span class="co"># Number of iterations for approximation of the true parameter of interest</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  B &lt;-<span class="st"> </span><span class="fl">1e2</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  <span class="co"># The intervention we are interested in</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  intervention  &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">when =</span> <span class="kw">c</span>(<span class="dv">2</span>), <span class="dt">what =</span> <span class="kw">c</span>(<span class="dv">1</span>), <span class="dt">variable =</span> <span class="st">'A'</span>)</a>
<a class="sourceLine" id="cb5-6" data-line-number="6"></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">  <span class="co"># The time of the outcome we are interested in</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">  tau =<span class="st"> </span><span class="dv">2</span></a></code></pre></div>
</section><section id="simulation" class="level2"><h2>Simulation</h2>
<p>In order to have some data to use for testing, we have to create a simulator. This simulator uses the simulation scheme as defined in Blaauw, Chambaz and van der Laan, in prep.. For this scheme we can define various things for each of the data generating systems:</p>
<ul>
<li>
<code>stochMech</code>: the mechanism we use to generate the observations</li>
<li>
<code>param</code>: the number of steps <span class="math inline">\(t\)</span> the mechanism is connected to the past</li>
<li>
<code>rgen</code>: the mechanism for generating the observations</li>
</ul>
<p>For example:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">  complex_treatment =<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">  <span class="co"># Our covariate definition</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">  llW &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">    <span class="dt">stochMech=</span><span class="cf">function</span>(numberOfBlocks) {</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">      <span class="kw">rnorm</span>(numberOfBlocks, <span class="dv">0</span>, <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">    },</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">    <span class="dt">param=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="fl">-0.25</span>, <span class="fl">0.1</span>),</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">    <span class="dt">rgen=</span>identity</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">  )</a>
<a class="sourceLine" id="cb6-11" data-line-number="11"></a>
<a class="sourceLine" id="cb6-12" data-line-number="12">  <span class="co"># The treatment mechanism</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13">  llA &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb6-14" data-line-number="14">    <span class="dt">stochMech=</span><span class="cf">function</span>(ww) {</a>
<a class="sourceLine" id="cb6-15" data-line-number="15">      <span class="kw">rbinom</span>(<span class="kw">length</span>(ww), <span class="dv">1</span>, <span class="kw">expit</span>(ww))</a>
<a class="sourceLine" id="cb6-16" data-line-number="16">    },</a>
<a class="sourceLine" id="cb6-17" data-line-number="17">    <span class="dt">param=</span><span class="kw">c</span>(<span class="op">-</span><span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.25</span>),</a>
<a class="sourceLine" id="cb6-18" data-line-number="18">    <span class="dt">rgen=</span><span class="cf">function</span>(xx, <span class="dt">delta=</span><span class="fl">0.05</span>){</a>
<a class="sourceLine" id="cb6-19" data-line-number="19">      probability &lt;-<span class="st"> </span>delta<span class="op">+</span>(<span class="dv">1-2</span><span class="op">*</span>delta)<span class="op">*</span><span class="kw">expit</span>(xx)</a>
<a class="sourceLine" id="cb6-20" data-line-number="20">      <span class="kw">rbinom</span>(<span class="kw">length</span>(xx), <span class="dv">1</span>, probability)</a>
<a class="sourceLine" id="cb6-21" data-line-number="21">    }</a>
<a class="sourceLine" id="cb6-22" data-line-number="22">  )</a>
<a class="sourceLine" id="cb6-23" data-line-number="23"></a>
<a class="sourceLine" id="cb6-24" data-line-number="24">  <span class="co"># The outcome variable</span></a>
<a class="sourceLine" id="cb6-25" data-line-number="25">  <span class="cf">if</span> (complex_treatment) {</a>
<a class="sourceLine" id="cb6-26" data-line-number="26">      rgenfunction =<span class="st"> </span><span class="cf">function</span>(AW){</a>
<a class="sourceLine" id="cb6-27" data-line-number="27">        aa &lt;-<span class="st"> </span>AW[, <span class="st">"A"</span>]</a>
<a class="sourceLine" id="cb6-28" data-line-number="28">        ww &lt;-<span class="st"> </span>AW[, <span class="kw">grep</span>(<span class="st">"[^A]"</span>, <span class="kw">colnames</span>(AW))]</a>
<a class="sourceLine" id="cb6-29" data-line-number="29">        mu &lt;-<span class="st"> </span>aa<span class="op">*</span>(<span class="fl">0.4-0.2</span><span class="op">*</span><span class="kw">sin</span>(ww)<span class="op">+</span><span class="fl">0.05</span><span class="op">*</span>ww) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">-</span>aa)<span class="op">*</span>(<span class="fl">0.2+0.1</span><span class="op">*</span><span class="kw">cos</span>(ww)<span class="op">-</span><span class="fl">0.03</span><span class="op">*</span>ww)</a>
<a class="sourceLine" id="cb6-30" data-line-number="30">        <span class="kw">rnorm</span>(<span class="kw">length</span>(mu), mu, <span class="dt">sd=</span><span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb6-31" data-line-number="31">      } </a>
<a class="sourceLine" id="cb6-32" data-line-number="32">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb6-33" data-line-number="33">        rgenfunction =<span class="st"> </span><span class="cf">function</span>(AW){</a>
<a class="sourceLine" id="cb6-34" data-line-number="34">        aa &lt;-<span class="st"> </span>AW[, <span class="st">"A"</span>]</a>
<a class="sourceLine" id="cb6-35" data-line-number="35">        mu &lt;-<span class="st"> </span><span class="dv">19</span> <span class="op">+</span><span class="st"> </span>aa<span class="op">*</span>(<span class="fl">0.9</span>) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">-</span>aa)<span class="op">*</span>(<span class="fl">0.3</span>)</a>
<a class="sourceLine" id="cb6-36" data-line-number="36">        <span class="kw">rnorm</span>(<span class="kw">length</span>(mu), mu, <span class="dt">sd=</span><span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb6-37" data-line-number="37">      }</a>
<a class="sourceLine" id="cb6-38" data-line-number="38">  }</a>
<a class="sourceLine" id="cb6-39" data-line-number="39">  llY &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">rgen =</span> rgenfunction)</a></code></pre></div>
<p>Now, using these mechanisms we need to setup our simulator. First we define the ‘truth’, or in our case, an approximation of the true parameter of interest. This parameter specifies what we expect to receive if we would run the earlier specified intervention</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">  <span class="co"># Create the simulator</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  simulator  &lt;-<span class="st"> </span>OnlineSuperLearner<span class="op">::</span>Simulator.GAD<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">  <span class="co"># Approximate the truth under the treatment</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6">  result.approx &lt;-<span class="st"> </span><span class="kw">mclapply</span>(<span class="kw">seq</span>(B), <span class="cf">function</span>(bb) {</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">    when &lt;-<span class="st"> </span><span class="kw">max</span>(intervention<span class="op">$</span>when)</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">    data.int &lt;-<span class="st"> </span>simulator<span class="op">$</span><span class="kw">simulateWAY</span>(tau, <span class="dt">qw =</span> llW, <span class="dt">ga =</span> llA, <span class="dt">Qy =</span> llY,</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">                                      <span class="dt">intervention =</span> intervention, <span class="dt">verbose =</span> log)</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">    data.int<span class="op">$</span>Y[tau]</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">  }, <span class="dt">mc.cores =</span> cores) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="st">    </span>unlist</a>
<a class="sourceLine" id="cb7-13" data-line-number="13"></a>
<a class="sourceLine" id="cb7-14" data-line-number="14">  psi.approx &lt;-<span class="st"> </span><span class="kw">mean</span>(result.approx)</a>
<a class="sourceLine" id="cb7-15" data-line-number="15"></a>
<a class="sourceLine" id="cb7-16" data-line-number="16">  <span class="kw">print</span>(psi.approx)</a></code></pre></div>
<p>The next step is to use the mechanisms to create a test set of data. Note that we are wrapping our data in a Data.Static object. By doing so, we can easily swap this static dataframe out for a stream of incoming data.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">  data.train &lt;-<span class="st"> </span>simulator<span class="op">$</span><span class="kw">simulateWAY</span>(training_set_size <span class="op">+</span><span class="st"> </span>B <span class="op">+</span><span class="st"> </span><span class="dv">100</span>, <span class="dt">qw=</span>llW, <span class="dt">ga=</span>llA, <span class="dt">Qy=</span>llY, <span class="dt">verbose=</span>log)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  data.train.static &lt;-<span class="st"> </span>OnlineSuperLearner<span class="op">::</span>Data.Static<span class="op">$</span><span class="kw">new</span>(<span class="dt">dataset =</span> data.train)</a></code></pre></div>
</section><section id="the-onlinesuperlearner-initialization" class="level2"><h2>The OnlineSuperLearner initialization</h2>
<p>Now everything is set-up, we can start our super learner procedure. First let’s choose a set of estimators we wish to include in our learner. Note that OSL automatically creates a grid of learners based on te hyperparameters provided in the setup.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">  algos &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">  <span class="co">#algos &lt;- list(list(description='ML.H2O.randomForest-1tree',</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3">                        <span class="co">#algorithm = 'ML.H2O.randomForest',</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">                        <span class="co">#params = list(ntrees = 1)))</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"></a>
<a class="sourceLine" id="cb9-6" data-line-number="6">  <span class="co">#algos &lt;- append(algos, list(list(description='ML.H2O.randomForest-50trees',</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">                        <span class="co">#algorithm = 'ML.H2O.randomForest',</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8">                        <span class="co">#params = list(ntrees = 50))))</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"></a>
<a class="sourceLine" id="cb9-10" data-line-number="10">  <span class="co">#algos &lt;- append(algos, list(list(description='ML.H2O.gbm',</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11">                        <span class="co">#algorithm = 'ML.H2O.gbm')))</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"></a>
<a class="sourceLine" id="cb9-13" data-line-number="13">  algos &lt;-<span class="st"> </span><span class="kw">append</span>(algos, <span class="kw">list</span>(<span class="kw">list</span>(<span class="dt">algorithm =</span> <span class="st">'ML.XGBoost'</span>,</a>
<a class="sourceLine" id="cb9-14" data-line-number="14">                        <span class="dt">algorithm_params =</span> <span class="kw">list</span>(<span class="dt">alpha =</span> <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb9-15" data-line-number="15">                        <span class="dt">params =</span> <span class="kw">list</span>(<span class="dt">nbins =</span> <span class="kw">c</span>(<span class="dv">6</span>,<span class="dv">40</span>), <span class="dt">online =</span> <span class="ot">TRUE</span>))))</a>
<a class="sourceLine" id="cb9-16" data-line-number="16"></a>
<a class="sourceLine" id="cb9-17" data-line-number="17">  <span class="co">#algos &lt;- append(algos, list(list(algorithm = 'ML.H2O.gbm',</span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18">                        <span class="co">#algorithm_params = list(ntrees=c(10,20), min_rows=1),</span></a>
<a class="sourceLine" id="cb9-19" data-line-number="19">                        <span class="co">#params = list(nbins = c(6), online = TRUE))))</span></a>
<a class="sourceLine" id="cb9-20" data-line-number="20"></a>
<a class="sourceLine" id="cb9-21" data-line-number="21">  <span class="co">#algos &lt;- append(algos, list(list(algorithm = 'ML.H2O.randomForest',</span></a>
<a class="sourceLine" id="cb9-22" data-line-number="22">                        <span class="co">#algorithm_params = list(ntrees=c(10,20)),</span></a>
<a class="sourceLine" id="cb9-23" data-line-number="23">                        <span class="co">#params = list(nbins = c(6), online = TRUE))))</span></a>
<a class="sourceLine" id="cb9-24" data-line-number="24"></a>
<a class="sourceLine" id="cb9-25" data-line-number="25">  algos &lt;-<span class="st"> </span><span class="kw">append</span>(algos, <span class="kw">list</span>(<span class="kw">list</span>(<span class="dt">algorithm =</span> <span class="st">'condensier::speedglmR6'</span>,</a>
<a class="sourceLine" id="cb9-26" data-line-number="26">                        <span class="co">#algorithm_params = list(),</span></a>
<a class="sourceLine" id="cb9-27" data-line-number="27">                        <span class="dt">params =</span> <span class="kw">list</span>(<span class="dt">nbins =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">4</span>, <span class="dv">5</span>), <span class="dt">online =</span> <span class="ot">FALSE</span>))))</a>
<a class="sourceLine" id="cb9-28" data-line-number="28"></a>
<a class="sourceLine" id="cb9-29" data-line-number="29">  <span class="co">#algos &lt;- append(algos, list(list(algorithm = 'condensier::glmR6',</span></a>
<a class="sourceLine" id="cb9-30" data-line-number="30">                        ##algorithm_params = list(),</a>
<a class="sourceLine" id="cb9-31" data-line-number="31">                        <span class="co">#params = list(nbins = c(16, 20, 24, 30, 34, 40), online = FALSE))))</span></a></code></pre></div>
<p>We use the loglikelihood loss function as general loss function. In order to do so, we should make sure that we bound all variables between <span class="math inline">\(0\)</span> and <span class="math inline">\(1\)</span>. We create bounds for all variables in order to do so.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">  bounds &lt;-<span class="st"> </span>OnlineSuperLearner<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/OnlineSuperLearner/topics/PreProcessor.generate_bounds">PreProcessor.generate_bounds</a></span>(data.train)</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  pre_processor &lt;-<span class="st"> </span>PreProcessor<span class="op">$</span><span class="kw">new</span>(<span class="dt">bounds =</span> bounds)</a></code></pre></div>
<p>The next step is to define our random variables. In this example we only consider the default variables <span class="math inline">\(W\)</span>, <span class="math inline">\(A\)</span>, and <span class="math inline">\(Y\)</span>. Each of them is univariate, and the <span class="math inline">\(A\)</span> variable is a binary variable. Currently we only support the variable at time <span class="math inline">\(t\)</span> (<span class="math inline">\(W\)</span>, <span class="math inline">\(A\)</span>, or <span class="math inline">\(Y\)</span>) and a lagged version therof (<span class="math inline">\(*\_lag\_*\)</span>, e.g., <span class="math inline">\(A\_lag\_1\)</span>):</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">  W &lt;-<span class="st"> </span>OnlineSuperLearner<span class="op">::</span>RandomVariable<span class="op">$</span><span class="kw">new</span>(<span class="dt">formula =</span> W <span class="op">~</span><span class="st"> </span>Y_lag_<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>A_lag_<span class="dv">1</span> <span class="op">+</span><span class="st">  </span>W_lag_<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>Y_lag_<span class="dv">2</span>, <span class="dt">family =</span> <span class="st">'gaussian'</span>)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">  A &lt;-<span class="st"> </span>OnlineSuperLearner<span class="op">::</span>RandomVariable<span class="op">$</span><span class="kw">new</span>(<span class="dt">formula =</span> A <span class="op">~</span><span class="st"> </span>W <span class="op">+</span><span class="st"> </span>Y_lag_<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>A_lag_<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>W_lag_<span class="dv">1</span>, <span class="dt">family =</span> <span class="st">'binomial'</span>)</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">  Y &lt;-<span class="st"> </span>OnlineSuperLearner<span class="op">::</span>RandomVariable<span class="op">$</span><span class="kw">new</span>(<span class="dt">formula =</span> Y <span class="op">~</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span>W, <span class="dt">family =</span> <span class="st">'gaussian'</span>)</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"></a>
<a class="sourceLine" id="cb11-5" data-line-number="5">  variable_of_interest &lt;-<span class="st"> </span>Y</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">  randomVariables &lt;-<span class="st"> </span><span class="kw">c</span>(W, A, Y)</a></code></pre></div>
<p>Then we need to create a system that will define our summary measure generator. This step is a bit cumbersome and will be removed in later versions. The idea is that given the definition provided in the previous code block, we have to generate several variables (e.g. the lags). In order to do so, we use a SummaryMeasureGenerator, which will parse these formulae and create the necessary summary measures.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">  smg_factory &lt;-<span class="st"> </span>OnlineSuperLearner<span class="op">::</span>SMGFactory<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">  summaryMeasureGenerator &lt;-<span class="st"> </span>smg_factory<span class="op">$</span><span class="kw">fabricate</span>(randomVariables, <span class="dt">pre_processor =</span> pre_processor)</a></code></pre></div>
<p>The last step is to actually run and fit our SuperLearner and calculate its CV risk:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">osl  &lt;-<span class="st"> </span>OnlineSuperLearner<span class="op">::</span>OnlineSuperLearner<span class="op">$</span><span class="kw">new</span>(algos, <span class="dt">summaryMeasureGenerator =</span> summaryMeasureGenerator,</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">                                                   <span class="dt">verbose =</span> log, <span class="dt">pre_processor =</span> pre_processor)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">risk &lt;-<span class="st"> </span>osl<span class="op">$</span><span class="kw">fit</span>(data.train.static, <span class="dt">randomVariables =</span> randomVariables,</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">                <span class="dt">initial_data_size =</span> training_set_size <span class="op">/</span><span class="st"> </span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">                <span class="dt">max_iterations =</span> max_iterations,</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">                <span class="dt">mini_batch_size =</span> (training_set_size <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span>max_iterations)</a></code></pre></div>
<p>In order to see how well it can estimate we first generate our data set we want to use for testing as follows:</p>
<ul>
<li>Draw B observations from our simulator</li>
<li>Input one of these observations in our algorithm</li>
<li>Sample iteratively, and set a treatment using a prespecified when and then</li>
<li>Record the outcome of our variable of interest (<span class="math inline">\(Y\)</span>) at time tau and we denormalize it (converting it back to the original data format)</li>
<li>Repeat this procedure a large number of B times</li>
<li>Finally we take the average over all B observations, giving us our estimation of the parameter of interest.</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">  datas &lt;-<span class="st"> </span>summaryMeasureGenerator<span class="op">$</span><span class="kw">getNext</span>(<span class="dt">n =</span> B)</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">  do_parallel &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4">  <span class="cf">if</span> (do_parallel) {</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">      result &lt;-<span class="st"> </span><span class="kw">mclapply</span>(<span class="kw">seq</span>(B), <span class="cf">function</span>(i) {</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">          osl<span class="op">$</span><span class="kw">sample_iteratively</span>(<span class="dt">data =</span> datas[i,],</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">                            <span class="dt">randomVariables =</span> randomVariables,</a>
<a class="sourceLine" id="cb14-8" data-line-number="8">                            <span class="dt">intervention =</span> intervention,</a>
<a class="sourceLine" id="cb14-9" data-line-number="9">                            <span class="dt">tau =</span> tau)[tau, <span class="st">'Y'</span>]</a>
<a class="sourceLine" id="cb14-10" data-line-number="10">      }, <span class="dt">mc.cores=</span> cores)</a>
<a class="sourceLine" id="cb14-11" data-line-number="11">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb14-12" data-line-number="12">      result &lt;-<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">i=</span><span class="kw">seq</span>(B), <span class="dt">.combine=</span>rbind) <span class="op">%do%</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb14-13" data-line-number="13">          osl<span class="op">$</span><span class="kw">sample_iteratively</span>(<span class="dt">data =</span> datas[i,],</a>
<a class="sourceLine" id="cb14-14" data-line-number="14">                            <span class="dt">randomVariables =</span> randomVariables,</a>
<a class="sourceLine" id="cb14-15" data-line-number="15">                            <span class="dt">intervention =</span> intervention,</a>
<a class="sourceLine" id="cb14-16" data-line-number="16">                            <span class="dt">tau =</span> tau)[tau, <span class="st">'Y'</span>]</a>
<a class="sourceLine" id="cb14-17" data-line-number="17">      }</a>
<a class="sourceLine" id="cb14-18" data-line-number="18">  }</a>
<a class="sourceLine" id="cb14-19" data-line-number="19"></a>
<a class="sourceLine" id="cb14-20" data-line-number="20">  result <span class="op">%&lt;&gt;%</span><span class="st"> </span>unlist</a></code></pre></div>
<p>Finally, we can see how well the algorithms converge and estimate the approximated truth. The following plot shows this convergence for both the approximation (i.e., truth, black), and the estimation (red).</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">  <span class="co"># Calculate psi</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2">  psi.estimation &lt;-<span class="st"> </span><span class="kw">mean</span>(result)</a>
<a class="sourceLine" id="cb15-3" data-line-number="3"></a>
<a class="sourceLine" id="cb15-4" data-line-number="4">  <span class="co"># Plot the convergence</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5">  y1 &lt;-<span class="st"> </span><span class="kw">cumsum</span>(result.approx)<span class="op">/</span><span class="kw">seq</span>(<span class="dt">along=</span>result.approx)</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">  y2 &lt;-<span class="st"> </span><span class="kw">cumsum</span>(result)<span class="op">/</span><span class="kw">seq</span>(<span class="dt">along=</span>result)</a>
<a class="sourceLine" id="cb15-7" data-line-number="7"></a>
<a class="sourceLine" id="cb15-8" data-line-number="8">  <span class="kw">plot</span>(y1, <span class="dt">ylim=</span><span class="kw">range</span>(<span class="kw">c</span>(y1,y2)))</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">  <span class="kw">par</span>(<span class="dt">new=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb15-10" data-line-number="10">  <span class="kw">plot</span>(y2, <span class="dt">ylim=</span><span class="kw">range</span>(<span class="kw">c</span>(y1,y2)), <span class="dt">col=</span><span class="st">"red"</span>, <span class="dt">axes =</span> <span class="ot">FALSE</span>, <span class="dt">xlab =</span> <span class="st">""</span>, <span class="dt">ylab =</span> <span class="st">""</span>)</a>
<a class="sourceLine" id="cb15-11" data-line-number="11"></a>
<a class="sourceLine" id="cb15-12" data-line-number="12">  <span class="co"># Print the outcome</span></a>
<a class="sourceLine" id="cb15-13" data-line-number="13">  <span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">'We have approximated psi as'</span>, psi.approx, </a>
<a class="sourceLine" id="cb15-14" data-line-number="14">              <span class="st">'our estimate is'</span>, psi.estimation, </a>
<a class="sourceLine" id="cb15-15" data-line-number="15">              <span class="st">'which is a difference of:'</span>, <span class="kw">abs</span>(psi.approx <span class="op">-</span><span class="st"> </span>psi.estimation)))</a></code></pre></div>
<p>The result should be something like:</p>
<pre class="plain"><code>[1] "We have approximated psi as 19.9016316150146 our estimate is 19.9018591048906 which is a difference of: 0.000227489875989306"</code></pre>
</section>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#quick-start">Quick start</a></li>
      <li><a href="#install-dependencies">Install dependencies</a></li>
      <li><a href="#configuration">Configuration</a></li>
      <li><a href="#simulation">Simulation</a></li>
      <li><a href="#the-onlinesuperlearner-initialization">The OnlineSuperLearner initialization</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Frank Blaauw, Antoine Chambaz.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
